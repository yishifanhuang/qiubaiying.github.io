---
layout:     post
title:      记一次奇葩网络故障排查历程
subtitle:   "\"求你们不要学习，快跟不上了\""
date:       2018-03-12
author:     XYZ
header-img: img/post-bg-2015.jpg
catalog:    true
tags:
    - 职业
---


>一次奇葩网络故障排查历程

## 网络故障起因
在OA单上接到有人反映这样的情况40.248炸单测试服务器正常运行，客户端终端机器40.58这两台机器却网络发现了服务器。设置连普通的ping都ping不通。用户在重启电脑之后，开始可以连接服务的，隔上五六分钟又会出现异常。
40.248服务器是一台四核心八线程的服务器，内存是12GB，服务器操作系统是Windows server 2008服务器，机子上面运行着炸弹测试系统，为KD系统室的测试人员提供一个炸单测试环境。
![](https://s1.ax1x.com/2018/03/12/9fcTXt.png)


接到反馈，开始故障排查。
一：客户端终端排查
1.排查是否终端设置故障、恶意软件导致。重启电脑不启动任何进程，在使用命令ping 10.8.40.248 -t时，由连通姿态-》掉包-》请求超时。而客户端能正常访问其他网络服务。
2.排查终端是否防火墙设置了规则，打开控制面板查看，无论是域网络防火墙，专用网络防火墙，公共网络防火墙设置都正常无误。
3.使用360安全管家对系统全盘扫描，发现无病毒。网络故障异常依然存在。

二：网络通信故障排查
1.更换终端MAC地址再次访问40.248共享文件夹，对比附近机子，查看其arp -a 是否发生了arp劫持，查看对比MAC正常，对比机能正常访问，出现故障无法访问。
2.更换终端IP，在网络发配中，每个网段都会有保留地址，固定其IP为10.8.40.3，依然出现故障无法访问。
3.想不到其他可能的网络故障点，用户反馈说不只一人出现这种情况，该部门的其他员工也回碰到这种情况，由此可以我猜想可能是服务器ACL做了控制，对访问次数多的机器进行限制。

三：服务器规则排查
1.寻找服务器相关负责人，（40.248服务器不是归我们负责，这是由开发室的人员进行维护），运维人员说没有进行任何访问列表控制。抛锅说是网络出现的故障。在经过一一的排查之后，因为40.248服务器只是一台性能比较好的PC机，查看了资源管理器，无论是CPU、内存、磁盘I/O上都无问题，而在测试链接40.58却一直请求超时。
2.快要毫无进展的时候，网络组的同事突然有了新的发现。（因为一直有人怀疑是网络的问题，所以网络组的同事也在寻找相关故障）发现在ping 10.8.40.248 -t上在退出卡巴斯基之后就可以访问了。

定位问题：
1.首先卡巴斯基关闭之后，就可以联通了。有人就说直接退出卡巴斯基或者安装其他安全软件就解决问题。首先先说明公司上网两个必备的条件：上网小助手IsAgent和杀毒软件卡巴斯基两个条件。在不符合条件之下，用户只能一天上网的时间。
2.卡巴斯基设置服务白名单。把10.8.40.248加入白名单过程中。发现，服务器中毒，中毒，中毒。接着又发现服务器没有杀毒软件。裸奔姿态运行服务。

再次定位问题：服务器中毒，结果发现MS17-010漏洞代码模块利用病毒永恒之蓝。导致445文件共享端口被感染。
![](https://s1.ax1x.com/2018/03/12/9fco6I.png)
终于定位到准确的问题。然而现在出现的情况就是裸奔服务器上安装卡巴斯基，可能之后会导致其他问题。而且服务器也不能说停止就停止。有着客户和测试人员在使用着。虽然定位到了问题，但距离解决问题还需要继续努力。

网络安全说到底是一场博弈，魔高一尺，还需道高一丈,在如今的网络安全攻防战场上，攻击的技术与理念日益精进，。网络安全形势十分严峻，重要的服务即使运行在内网之中也不能保证其安全。所以：不做“亡羊补牢”事后预警，应做到“未雨绸缪”提前防护。

## 后记
永恒之蓝是指2017年5月12日起，全球范围内爆发的基于Windows网络共享协议进行攻击传播的蠕虫恶意代码，不法分子通过改造之前泄露的NSA黑客武器库中“永恒之蓝”攻击程序发起的网络攻击事件。恶意代码会扫描开放445文件共享端口的Windows机器，无需用户任何操作，只要开机上网，不法分子就能在电脑和服务器中植入勒索软件、远程控制木马、虚拟货币挖矿机等恶意程序。
